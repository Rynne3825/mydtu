<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - Contacts</title>
    <style>
      body {
        font-family: system-ui, Arial, sans-serif;
        max-width: 1100px;
        margin: 36px auto;
        padding: 0 16px;
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      input {
        padding: 10px 12px;
        border: 1px solid #ccc;
        border-radius: 10px;
        font-size: 14px;
      }
      button {
        padding: 10px 12px;
        border: 0;
        border-radius: 10px;
        cursor: pointer;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }
      th,
      td {
        border-bottom: 1px solid #eee;
        padding: 10px;
        vertical-align: top;
        text-align: left;
      }
      th {
        background: #fafafa;
        position: sticky;
        top: 0;
      }
      .muted {
        color: #666;
        font-size: 13px;
        margin-top: 10px;
      }
      .msg {
        white-space: pre-wrap;
      }
      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        background: #f2f2f2;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>Admin - Contacts</h1>
    <p class="muted">Xem danh sách tin nhắn đã lưu trong D1.</p>

    <div class="row">
      <input id="token" placeholder="ADMIN_TOKEN" size="28" />
      <input id="limit" type="number" min="1" max="200" value="50" />
      <button id="loadBtn">Tải dữ liệu</button>
      <span id="status" class="badge"></span>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width: 80px">ID</th>
          <th style="width: 180px">Tên</th>
          <th style="width: 220px">Email</th>
          <th>Nội dung</th>
          `
          <th style="width: 170px">Thời gian</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <script>
      const tbody = document.getElementById("tbody");
      const tokenEl = document.getElementById("token");
      const limitEl = document.getElementById("limit");
      const statusEl = document.getElementById("status");
      const loadBtn = document.getElementById("loadBtn");

      function setStatus(text) {
        statusEl.textContent = text || "";
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      async function loadContacts() {
        setStatus("Đang tải...");
        tbody.innerHTML = "";
        loadBtn.disabled = true;

        try {
          const token = tokenEl.value.trim();
          const limit = Math.min(
            parseInt(limitEl.value || "50", 10) || 50,
            200
          );

          const url = new URL("/api/contacts", location.origin);
          url.searchParams.set("limit", String(limit));
          if (token) url.searchParams.set("token", token);

          const res = await fetch(url.toString(), { method: "GET" });
          const text = await res.text();
          let data = {};
          try {
            data = JSON.parse(text);
          } catch {}

          if (!res.ok || data.success !== true) {
            throw new Error(data.error || `HTTP ${res.status}: ${text}`);
          }

          const rows = data.results || [];
          if (rows.length === 0) {
            setStatus("Không có dữ liệu");
            return;
          }

          for (const r of rows) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${escapeHtml(r.id)}</td>
              <td>${escapeHtml(r.name)}</td>
              <td>${escapeHtml(r.email)}</td>
              <td class="msg">${escapeHtml(r.message)}</td>
              <td>${escapeHtml(r.created_at)}</td>
            `;
            tbody.appendChild(tr);
          }

          setStatus(`OK: ${rows.length} dòng`);
        } catch (err) {
          setStatus("Lỗi: " + err.message);
        } finally {
          loadBtn.disabled = false;
        }
      }

      loadBtn.addEventListener("click", loadContacts);
      // auto load (nếu không dùng token, hoặc bạn đã nhập token)
      loadContacts();
    </script>
  </body>
</html>
